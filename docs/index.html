<html>

<head>
    <title>i-share</title>
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <style type="text/css">
        #content {
            width: 20rem;
            height: 300px;
        }
    </style>
</head>

<body>
    <div>
        <div>
            <div><label for="type">uuid</label></div>
            <div><select id="type">
                    <option value="SimpleTxtMessage">SimpleTxtMessage</option>
                    <option value="Base64ImgMessage">Base64ImgMessage</option>
                </select></div>
        </div>
        <div>
            <div><label for="uuid">uuid</label></div>
            <div><input id="uuid" type="text" name="uuid" /></div>
        </div>
        <div>
            <div><label for="code">code</label></div>
            <div><input id="code" type="text" name="code" /></div>
        </div>
        <div>
            <div><label for="content">content</label></div>
            <div id="contentBox"><textarea id="content" name="content"></textarea></div>
            <div id="contentFileBox" style="display: none"><input id="contentFile" type="file" /></div>
        </div>
        <input id="submit" type="submit" value="Send">
        <!--    <input id="reset" type="reset" value="Reset">-->

        <p>访问地址</p>
        <div>
            <a id="url" href="" target="_blank"></a>
        </div>
    </div>
    <script>
        function run(input_file, get_data) {
            /*input_file：文件按钮对象*/
            /*get_data: 转换成功后执行的方法*/
            if (typeof (FileReader) === 'undefined') {
                alert("抱歉，你的浏览器不支持 FileReader，不能将图片转换为Base64，请使用现代浏览器操作！");
            } else {
                try {
                    /*图片转Base64 核心代码*/
                    var file = input_file.files[0];
                    //这里我们判断下类型如果不是图片就返回 去掉就可以上传任意文件
                    if (!/image\/\w+/.test(file.type)) {
                        alert("请确保文件为图像类型");
                        return false;
                    }
                    var reader = new FileReader();
                    reader.onload = function () {
                        get_data(this.result);
                    }
                    reader.readAsDataURL(file);
                } catch (e) {
                    alert('图片转Base64出错啦！' + e.toString())
                }
            }
        }


        $(() => {

            const is_prod = true
            const baseUrl = is_prod ? "http://119.23.190.226/i-share/" : "http://127.0.0.1/";
            const current_location = window.location.href
            const $content = $('#content');
            const $contentBox = $('#contentBox');
            const $contentFileBox = $('#contentFileBox');
            const $type = $('#type');
            const $contentFile = $('#contentFile');

            $('#type').change(() => {
                let typeValue = $('#type').val();
                console.log(typeValue)
                if (typeValue === 'Base64ImgMessage') {
                    $contentBox.hide()
                    $contentFileBox.show()
                    $content.val('')
                } else {
                    $contentBox.show()
                    $contentFileBox.hide()
                    $content.val('')
                }
            });

            $contentFile.change(() => {
                run($contentFile[0], (data) => {
                    $content.val(data)
                })
            })

            $('#submit').click(() => {
                let uuid = $('#uuid').val();

                let content = $content.val();
                let code = $('#code').val();

                let type = $type.val();

                if (!uuid) {
                    uuid = new Date().getTime()
                }


                let data = {
                    uuid,
                    content,
                    code
                };
                // console.log(data)

                // post
                $.ajax({
                    type: "POST",
                    url: `${baseUrl}message?type=${type}`,
                    contentType: "application/json;charset=utf-8",
                    data: JSON.stringify(data),
                    dataType: "json",
                    success: function (resp) {
                        if (resp.code === 1) {
                            let url = `${current_location}message.html?uuid=${uuid}`;
                            $('#url').attr('href', url)
                            $('#url').html(url)
                        } else {
                            alert("发送失败" + JSON.stringify(resp.msg));
                        }

                    },
                    error: function (resp) {
                        alert("提交失败" + JSON.stringify(resp));
                    }
                });
            })
        })
    </script>
</body>

</html>